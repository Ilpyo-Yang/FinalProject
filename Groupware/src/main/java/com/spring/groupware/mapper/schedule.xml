<?xml version="1.0" encoding="UTF-8"?>

<!-- ==== #29. mapper 기본설정 ==== -->
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- ==== #29. 루트 엘리먼트 & 네임스페이스 설정(프로젝트 전체내에서 유일해야 한다.) ==== -->
<mapper namespace="schedule">
	
	<!-- === 일정번호 채번해오기 === -->
	<select id="goScdno" resultType="int">
		select schedule_seq.nextval
		from dual
	</select>
	
	<!-- === 일정 추가하기 === -->
	<insert id="scdAdd" parameterType="com.spring.groupware.schedule.model.ScheduleVO">
		insert into tbl_schedule(scdno, fk_scdno2, fk_mbr_seq, scdsubject, scdstartdate, scdenddate, place, attendance)
		values(#{scdno}, to_number(#{fk_scdno2}), to_number(#{fk_mbr_seq}), #{scdsubject}
		, to_date(#{scdstartdate} || ' ' || #{scdstartTm}, 'yyyy-mm-dd hh24:mi'), to_date(#{scdenddate} || ' ' || #{scdendTm},'yyyy-mm-dd hh24:mi')
		,#{place}, #{attendance})
	</insert>
	
	<!-- === 수정해야할 글 1개 가져오기 === -->
	<select id="getViewScd" parameterType="String" resultType="com.spring.groupware.schedule.model.ScheduleVO">
		select scdno, fk_scdno2, fk_mbr_seq, scdsubject, scdstartdate, scdenddate, place, attendance
		from tbl_schedule
		where scdno = to_number(#{scdno})
	</select>
	
	<!-- === 일정 수정하기 === -->
	<update id="editScd" parameterType="com.spring.groupware.schedule.model.ScheduleVO">
		update tbl_schedule set scdsubject = #{scdsubject}, scdstartdate = to_date(#{scdstartdate} || ' ' || #{scdstartTm}, 'yyyy-mm-dd hh24:mi'), scdenddate = to_date(#{scdenddate}|| ' ' || #{scdendTm} ,'yyyy-mm-dd hh24:mi'), place= #{place}, attendance= #{attendance}
		where scdno = to_number(#{scdno})
	</update>
	
	<!-- === 일정 삭제하기 === -->
	<delete id="delScd" parameterType="String">
		delete from tbl_schedule
		where scdno = to_number(#{scdno})
	</delete>
	
	<!-- === 캘린더에 일정 보여주기 === -->
	<resultMap type="HashMap" id="showScdMap">
		<result property="scdno" column="scdno" javaType="String"/>
		<result property="fk_scdno2" column="fk_scdno2" javaType="String"/>
		<result property="scdsubject" column="scdsubject" javaType="String"/>
		<result property="scdstartdate" column="scdstartdate" javaType="String"/>
		<result property="scdenddate" column="scdenddate" javaType="String"/>
	</resultMap>
	
	<select id="showScd" parameterType="String" resultMap="showScdMap">
		select scdno, fk_scdno2, scdsubject, scdstartdate, scdenddate
		from tbl_schedule S join tbl_mbr M
		on S.fk_mbr_seq = M.mbr_seq
		where mbr_id = #{userid}
	</select>
	
	<!-- 모든 일정 삭제하기 -->
	<delete id="delAll" parameterType="int">
		delete from tbl_schedule
	</delete>
	
	<!-- ========================================================================================================== -->
	
	<!-- === 회의실 예약 번호 채번하기 === -->
	<select id="getNum" resultType="int">
		select mtrhistory_seq.nextval
		from dual
	</select>
	
	<!-- === 회의실 예약하기 === -->
	<insert id="resvMtrEnd" parameterType="com.spring.groupware.schedule.model.MtrHistoryVO">
		insert into tbl_mtrhistory(usemtrno, fk_scdno, fk_mtrno, mtrsubject, starttime, endtime)
		values(#{usemtrno}, #{fk_scdno}, #{fk_mtrno}, #{mtrsubject}, to_date(#{regDate} || ' ' || #{starttime},'yyyy-mm-dd hh24:mi'), to_date(#{regDate} || ' ' || #{endtime},'yyyy-mm-dd hh24:mi'))
	</insert>
	
	<!-- === 일정명 가져오기 === -->
	<select id="getScdSubject" parameterType="String" resultType="String">
		select scdsubject
		from tbl_schedule
		where scdno = #{scdno}
	</select>
	
	<!-- === 회의실명 가져오기 === -->
	<select id="getMtrName" parameterType="String" resultType="String">
		select mtrname
		from tbl_mtr
		where mtrno = #{fk_mtrno}
	</select>
	
	<!-- === 회의실 예약 내역 조회 === -->
	<select id="getViewMtr" parameterType="String" resultType="com.spring.groupware.schedule.model.MtrHistoryVO">
		select M.mtrname, H.regDate, H.starttime, H.endtime
		from tbl_mtrhistory H join tbl_mtr M
		on H.fk_mtrno = M.mtrno
		where usemtrno = #{usemtrno}
	</select>
	
	<!-- === 회의실 예약취소(삭제) === -->
	<delete id="delMtrReg" parameterType="String">
		delete from tbl_mtrhistory
		where usemtrno = to_number(#{usemtrno})
	</delete>
	
	<!-- === 회의실 예약현황 보여주기(구글 차트) === -->
	<resultMap type="HashMap" id="goRegMtrMap">
		<result property="mtrname" column="mtrname" javaType="String"/>
		<result property="scdsubject" column="scdsubject" javaType="String"/>
		<result property="regDate" column="regDate" javaType="String"/>
		<result property="starttime" column="starttime" javaType="String"/>
		<result property="endtime" column="endtime" javaType="String"/>
	</resultMap>
	
	<select id="goRegMtr" resultMap="goRegMtrMap">
		select mtrname, scdsubject, regDate, starttime, endtime
		from tbl_schedule S join tbl_mtrhistory H
		on S.scdno = H.fk_scdno
		join tbl_mtr M
		on H.fk_mtrno = M.mtrno
	</select>
	
	
	
</mapper>